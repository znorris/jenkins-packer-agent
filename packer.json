{
  "variables": {
    "base_image": "",
    "github_token": "",
    "git_branch": "",
    "git_commit": "",
    "image_registry": "",
    "image_tag": ""
  },
  "builders": [
    {
      "type": "docker",
      "image": "{{user `base_image`}}",
      "run_command": ["-d", "-i", "-t", "-u", "root", "{{.Image}}", "/bin/bash"],
      "commit": "true"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "packer_0.8.6_SHA256SUMS",
      "destination": "/packer_0.8.6_SHA256SUMS"
    },
    {
      "type": "shell",
      "inline": [
        "apt-get update -y",
        "apt-get upgrade -y",
        "apt-get install -y --no-install-recommends supervisor default-jre unzip curl git rsync --fix-missing",
        "useradd -c 'Jenkins agent' -d /home/jenkins-agent -m jenkins-agent",
        "curl --create-dirs -sSLo /usr/share/jenkins/swarm-client-jar-with-dependencies.jar http://maven.jenkins-ci.org/content/repositories/releases/org/jenkins-ci/plugins/swarm-client/2.0/swarm-client-2.0-jar-with-dependencies.jar",
        "curl -sSL https://releases.hashicorp.com/packer/0.8.6/packer_0.8.6_linux_amd64.zip -o packer_0.8.6_linux_amd64.zip && unzip packer_0.8.6_linux_amd64.zip -d /usr/local/bin"
      ]
    },
    {
      "type": "file",
      "source": "supervisord.conf",
      "destination": "/etc/supervisor/conf.d/supervisord.conf"
    },
    {
      "type": "file",
      "source": "jenkins-docker-supervisor.sh",
      "destination": "/usr/local/bin/jenkins-docker-supervisor.sh"
    },
    {
      "type": "shell",
      "environment_vars" : [ "CLOUDSDK_PYTHON_SITEPACKAGES=1" ],
      "inline": [
        "apt-get install -y -qq --no-install-recommends wget python openssh-client",
        "apt-get clean",
        "cd /usr/local/bin",
        "wget -nv https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.zip",
        "unzip google-cloud-sdk.zip",
        "rm google-cloud-sdk.zip",
        "google-cloud-sdk/install.sh --usage-reporting=true --path-update=true --bash-completion=true --rc-path=/.bashrc --additional-components kubectl",
        "google-cloud-sdk/bin/gcloud --quiet components update",
        "google-cloud-sdk/bin/gcloud --quiet config set component_manager/disable_update_check true",
        "google-cloud-sdk/bin/gcloud components list",
      	"ln -s /usr/local/bin/google-cloud-sdk/bin/gcloud /usr/local/bin/gcloud",
      	"ln -s /usr/local/bin/google-cloud-sdk/bin/gsutil /usr/local/bin/gsutil"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "chmod 755 /usr/share/jenkins",
        "chmod +x /usr/local/bin/jenkins-docker-supervisor.sh"
      ]
    }
  ],
  "post-processors": [
    [
        {
            "type": "docker-tag",
            "repository": "{{user `image_registry`}}",
            "tag": "{{user `image_tag`}}",
            "only": ["docker"],
            "force": true
        }
    ],
    [
        {
            "type": "docker-tag",
            "repository": "{{user `image_registry`}}",
            "tag": "{{user `git_branch`}}-latest",
            "only": ["docker"],
            "force": true
        }
    ]
  ]
}
